name: VERASSO CI/CD Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  workflow_dispatch:
    inputs:
      skip_tests:
        description: "Skip tests (only for hotfix)"
        required: false
        default: "false"

env:
  FLUTTER_VERSION: "3.29.0"
  COVERAGE_THRESHOLD: 50

jobs:
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # STAGE 1: CODE QUALITY & ANALYSIS
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  analyze:
    runs-on: ubuntu-latest
    name: ğŸ“Š Code Analysis & Formatting
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ”§ Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          cache: true

      - name: ğŸ“¦ Install dependencies
        run: flutter pub get

      - name: ğŸ” Run flutter analyze
        run: flutter analyze --fatal-infos

      - name: ğŸ¨ Check code formatting
        run: dart format --set-exit-if-changed .

      - name: ğŸ“‹ Generate SARIF for code quality
        run: flutter analyze --format=json > analysis.json 2>&1 || true

    # Allow main branch to proceed even with non-fatal issues
    continue-on-error: ${{ github.ref == 'refs/heads/main' }}

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # STAGE 2: SECURITY SCANNING
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  security:
    runs-on: ubuntu-latest
    name: ğŸ”’ Security & Credential Scanning
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ” Check for hardcoded credentials
        run: |
          echo "ğŸ” Scanning for exposed credentials..."

          # Check for hardcoded API keys (exclude String.fromEnvironment declarations)
          if grep -rn "SUPABASE_KEY\|SECRET_KEY\|firebase_key\|auth_token" lib/ --include="*.dart" --exclude-dir=.git | grep -v "fromEnvironment" | grep -v "//"; then
            echo "âŒ Found potential hardcoded credentials in source code"
            exit 1
          fi

          echo "âœ… No hardcoded credentials detected"

      - name: ğŸ”“ Check for dangerous patterns
        run: |
          echo "ğŸ” Scanning for dangerous code patterns..."

          # Check for dangerous functions (exclude sandbox blocklists)
          if grep -r "eval(\|exec(\|system(" lib/ --include="*.dart" --exclude-dir=sandbox; then
            echo "âŒ Found dangerous function calls"
            exit 1
          fi

          # Check for disabled SSL validation (security risk)
          if grep -r "HttpClient\|allowBadCertificates" lib/ --include="*.dart"; then
            echo "âš ï¸  Warning: Found HTTP client instantiation (verify SSL validation)"
          fi

          echo "âœ… No dangerous patterns detected"

      - name: ğŸ“§ Check for exposed email addresses in code
        run: |
          echo "ğŸ” Scanning for exposed email addresses..."
          if grep -r "[a-zA-Z0-9._%+-]\+@[a-zA-Z0-9.-]\+\.[a-zA-Z]\{2,\}" lib/ --include="*.dart" --exclude-dir=generated; then
            echo "âš ï¸  Warning: Found email addresses in source code (use .env)"
          fi

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # STAGE 3: UNIT & INTEGRATION TESTS
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  test:
    runs-on: ubuntu-latest
    name: ğŸ§ª Unit & Integration Tests
    needs: analyze
    if: github.event.inputs.skip_tests != 'true'
    steps:
      - uses: actions/checkout@v4

      - name: ğŸ”§ Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          cache: true

      - name: ğŸ“¦ Install dependencies
        run: flutter pub get

      - name: ğŸ§ª Run all tests with coverage
        run: flutter test --coverage --verbose
        continue-on-error: true

      - name: ğŸ“Š Check coverage threshold
        run: |
          if [ -f "coverage/lcov.info" ]; then
            sudo apt-get update && sudo apt-get install -y lcov
            COVERAGE_FLOAT=$(lcov --summary coverage/lcov.info 2>&1 | grep "lines" | grep -oP '\d+\.\d+' || echo "0.0")
            COVERAGE=${COVERAGE_FLOAT%.*}
            echo "ğŸ“ˆ Code Coverage: $COVERAGE_FLOAT%"
            
            if [ "$COVERAGE" -lt "${{ env.COVERAGE_THRESHOLD }}" ]; then
              echo "::error::Coverage ($COVERAGE_FLOAT%) below threshold (${{ env.COVERAGE_THRESHOLD }}%)"
              exit 1
            fi
          fi

      - name: ğŸ“¤ Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          files: ./coverage/lcov.info
          flags: flutter
          name: codecov-umbrella
          fail_ci_if_error: false

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # STAGE 4: BUILD VERIFICATION (Android)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  build_android:
    runs-on: ubuntu-latest
    name: ğŸ¤– Build Android APK
    needs: [analyze, test]
    steps:
      - uses: actions/checkout@v4

      - name: ğŸ”§ Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          cache: true

      - name: ğŸ“¦ Install dependencies
        run: flutter pub get

      - name: ğŸ—ï¸ Build Android APK (Debug)
        run: flutter build apk --debug --no-shrink

      - name: ğŸ“¤ Upload APK artifact
        uses: actions/upload-artifact@v4
        with:
          name: app-debug.apk
          path: build/app/outputs/flutter-apk/app-debug.apk
          retention-days: 7

      - name: ğŸ—ï¸ Build Android App Bundle (Release)
        if: startsWith(github.ref, 'refs/tags/v')
        env:
          CI_SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          CI_SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
          CI_GEMINI_KEY: ${{ secrets.GEMINI_API_KEY }}
          STORE_PASSWORD: ${{ secrets.STORE_PASSWORD }}
          KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}
          KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
          KEY_PATH: ${{ secrets.KEY_PATH }}
        run: |
          flutter build appbundle --release --no-pub \
            --dart-define=SUPABASE_URL=$CI_SUPABASE_URL \
            --dart-define=SUPABASE_ANON_KEY=$CI_SUPABASE_ANON_KEY \
            --dart-define=G_M_SPECIAL_K=$CI_GEMINI_KEY \
            --dart-define=O_R_SPECIAL_K=${{ secrets.OPENROUTER_API_KEY }} \
            --dart-define=RAZORPAY_KEY_ID=${{ secrets.RAZORPAY_KEY_ID }}

      - name: ğŸ“¤ Upload App Bundle artifact
        if: startsWith(github.ref, 'refs/tags/v')
        uses: actions/upload-artifact@v4
        with:
          name: app-release.aab
          path: build/app/outputs/bundle/release/app-release.aab
          retention-days: 30

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # STAGE 5: BUILD VERIFICATION (iOS)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  build_ios:
    runs-on: macos-latest
    name: ğŸ Build iOS IPA
    needs: [analyze, test]
    steps:
      - uses: actions/checkout@v4

      - name: ğŸ”§ Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          cache: true

      - name: ğŸ“¦ Install dependencies
        run: flutter pub get

      - name: ğŸ—ï¸ Build iOS IPA (No Codesign)
        env:
          CI_SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          CI_SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
          CI_GEMINI_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          flutter build ipa --release --no-codesign \
            --dart-define=SUPABASE_URL=$CI_SUPABASE_URL \
            --dart-define=SUPABASE_ANON_KEY=$CI_SUPABASE_ANON_KEY \
            --dart-define=G_M_SPECIAL_K=$CI_GEMINI_KEY \
            --dart-define=O_R_SPECIAL_K=${{ secrets.OPENROUTER_API_KEY }} \
            --dart-define=RAZORPAY_KEY_ID=${{ secrets.RAZORPAY_KEY_ID }}

      - name: ğŸ“¤ Upload IPA artifact
        uses: actions/upload-artifact@v4
        with:
          name: app-release.ipa
          path: build/ios/ipa/
          retention-days: 7

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # FINAL: SUCCESS CHECK & NOTIFICATIONS
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  success:
    runs-on: ubuntu-latest
    name: âœ… CI/CD Pipeline Complete
    needs: [analyze, security, test, build_android, build_ios]
    if: always()
    steps:
      - name: ğŸ“Š Generate Summary
        run: |
          echo "## ğŸ‰ CI/CD Pipeline Summary"
          echo "- âœ… Code Analysis: ${{ needs.analyze.result }}"
          echo "- ğŸ”’ Security Scan: ${{ needs.security.result }}"
          echo "- ğŸ§ª Tests: ${{ needs.test.result }}"
          echo "- ğŸ¤– Android Build: ${{ needs.build_android.result }}"
          echo "- ğŸ iOS Build: ${{ needs.build_ios.result }}"

      - name: ğŸš¨ Check Pipeline Status
        if: failure()
        run: exit 1
